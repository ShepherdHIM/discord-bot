const { SlashCommandBuilder, EmbedBuilder, ActionRowBuilder, ButtonBuilder, ButtonStyle } = require('discord.js');

module.exports = {
    data: new SlashCommandBuilder()
        .setName('bilgi_yarismasi')
        .setDescription('XP ve coin kazanmak icin bilgi yarismasi oynayin!')
        .addStringOption(option =>
            option.setName('kategori')
                .setDescription('Bilgi yarƒ±≈ümasƒ± kategorisi se√ßin')
                .setRequired(false)
                .addChoices(
                    { name: 'Genel Bilgi', value: 'general' },
                    { name: 'Oyun', value: 'gaming' },
                    { name: 'Bilim', value: 'science' },
                    { name: 'Tarih', value: 'history' },
                    { name: 'Rastgele', value: 'random' }
                ))
        .addStringOption(option =>
            option.setName('zorluk')
                .setDescription('Zorluk seviyesi se√ßin')
                .setRequired(false)
                .addChoices(
                    { name: 'Kolay', value: 'easy' },
                    { name: 'Orta', value: 'medium' },
                    { name: 'Zor', value: 'hard' }
                )),

    async execute(interaction) {
        try {
            // Defer reply immediately to prevent timeout
            if (!interaction.replied && !interaction.deferred) {
                await interaction.deferReply();
            }
            
            const category = interaction.options.getString('kategori') || 'random';
            const difficulty = interaction.options.getString('zorluk') || 'medium';
            
            // Get voice manager for rewards
            const voiceManager = interaction.client.voiceManager;
            if (!voiceManager) {
                return interaction.editReply({ content: 'Bilgi yarƒ±≈ümasƒ± sistemi mevcut deƒüil!', ephemeral: true });
            }
            
            // Get user stats
            const userStats = await voiceManager.getUserStats(interaction.user.id, interaction.guildId);
            if (!userStats) {
                return interaction.editReply({ 
                    content: 'üß† √ñnce biraz XP kazanmanƒ±z gerekiyor! Yolculuƒüunuza ba≈ülamak i√ßin bir ses kanalƒ±na katƒ±lƒ±n!', 
                    ephemeral: true 
                });
            }
            
            // Get a random question
            const question = this.getRandomQuestion(category, difficulty);
            
            // Create answer buttons
            const row = new ActionRowBuilder();
            const shuffledAnswers = this.shuffleArray([...question.incorrect_answers, question.correct_answer]);
            
            shuffledAnswers.forEach((answer, index) => {
                row.addComponents(
                    new ButtonBuilder()
                        .setCustomId(`trivia_${index}_${answer === question.correct_answer ? 'correct' : 'incorrect'}`)
                        .setLabel(answer.length > 80 ? answer.substring(0, 77) + '...' : answer)
                        .setStyle(ButtonStyle.Primary)
                );
            });
            
            // Calculate potential rewards based on difficulty and reward ranges
            let xpReward, coinReward;
            const rewardRanges = await voiceManager.getActiveRewardRanges(interaction.guildId);
            const xpRanges = rewardRanges.filter(range => range.reward_type === 'xp');
            const coinRanges = rewardRanges.filter(range => range.reward_type === 'coin');
            
            // Calculate base rewards based on difficulty
            const rewardMultiplier = { easy: 1, medium: 1.5, hard: 2 }[difficulty];
            const baseXPReward = Math.floor(20 * rewardMultiplier);
            const baseCoinReward = Math.floor(15 * rewardMultiplier);
            
            // Use reward ranges if available, otherwise use base rewards
            if (xpRanges.length > 0) {
                const randomRange = xpRanges[Math.floor(Math.random() * xpRanges.length)];
                xpReward = Math.floor(Math.random() * (randomRange.max_amount - randomRange.min_amount + 1)) + randomRange.min_amount;
            } else {
                xpReward = baseXPReward;
            }
            
            if (coinRanges.length > 0) {
                const randomRange = coinRanges[Math.floor(Math.random() * coinRanges.length)];
                coinReward = Math.floor(Math.random() * (randomRange.max_amount - randomRange.min_amount + 1)) + randomRange.min_amount;
            } else {
                coinReward = baseCoinReward;
            }
            
            const embed = new EmbedBuilder()
                .setColor('#4169E1')
                .setTitle(`üß† ${this.getCategoryDisplayName(category)} Bilgi Yarƒ±≈ümasƒ±`)
                .setDescription(`**${this.getDifficultyDisplayName(difficulty)} Seviye Soru**\n\n${question.question}`)
                .addFields(
                    { name: 'üèÜ Doƒüru Cevap √ñd√ºl√º', value: `+${xpReward} XP, +${coinReward} coin`, inline: true },
                    { name: 'üéØ Yanlƒ±≈ü Cevap √ñd√ºl√º', value: `+5 XP (katƒ±lƒ±m)`, inline: true },
                    { name: '‚è∞ Zaman Sƒ±nƒ±rƒ±', value: '30 saniye', inline: true }
                )
                .setFooter({ 
                    text: `${interaction.user.username} ‚Ä¢ ${userStats.coins} coin ‚Ä¢ Seviye ${userStats.level}`,
                    iconURL: interaction.user.displayAvatarURL()
                })
                .setTimestamp();
            
            await interaction.editReply({ embeds: [embed], components: [row] });
            
            // Store trivia data for answer handling
            this.storeTriviaData(interaction.user.id, {
                question,
                difficulty,
                category,
                xpReward,
                coinReward,
                userStats,
                voiceManager,
                startTime: Date.now()
            });
            
            // Auto-timeout after 60 seconds
            setTimeout(async () => {
                const triviaData = this.getTriviaData(interaction.user.id);
                if (triviaData && !triviaData.answered) {
                    try {
                        const timeoutEmbed = new EmbedBuilder()
                            .setColor('#FF6B00')
                            .setTitle('‚è∞ S√ºre Doldu!')
                            .setDescription(`Doƒüru cevap: **${question.correct_answer}** idi`)
                            .addFields({ name: '√ñd√ºl', value: '+2 XP (zaman a≈üƒ±mƒ± bonusu)', inline: false })
                            .setFooter({ text: 'Ba≈üka bir soru deneyiniz!' });
                        
                        await interaction.editReply({ embeds: [timeoutEmbed], components: [] });
                        
                        // Give small consolation XP
                        await triviaData.voiceManager.updateUserStats(
                            interaction.user.id,
                            interaction.guildId,
                            triviaData.userStats.total_xp + 2,
                            triviaData.userStats.coins,
                            triviaData.userStats.voice_time_minutes
                        );
                    } catch (error) {
                        console.error('Error handling trivia timeout:', error);
                    }
                    this.triviaData.delete(interaction.user.id);
                }
            }, 60000);
            
        } catch (error) {
            console.error('Error in trivia command:', error);
            
            try {
                if (!interaction.replied && !interaction.deferred) {
                    await interaction.reply({ 
                        content: '‚ùå Bilgi yarƒ±≈ümasƒ± ba≈ülatƒ±lƒ±rken bir hata olu≈ütu!', 
                        ephemeral: true 
                    });
                } else {
                    await interaction.editReply({ 
                        content: '‚ùå Bilgi yarƒ±≈ümasƒ± ba≈ülatƒ±lƒ±rken bir hata olu≈ütu!', 
                        ephemeral: true 
                    });
                }
            } catch (replyError) {
                console.error('Error sending error response:', replyError);
            }
        }
    },
    
    getRandomQuestion(category, difficulty) {
        const questions = this.getQuestionBank();
        const categoryQuestions = category === 'random' ? 
            Object.values(questions).flat() : 
            questions[category] || questions.general;
        
        const difficultyQuestions = categoryQuestions.filter(q => q.difficulty === difficulty);
        const availableQuestions = difficultyQuestions.length > 0 ? difficultyQuestions : categoryQuestions;
        
        return availableQuestions[Math.floor(Math.random() * availableQuestions.length)];
    },
    
    getQuestionBank() {
        return {
            general: [
                {
                    question: "T√ºrkiye'nin ba≈ükenti neresidir?",
                    correct_answer: "Ankara",
                    incorrect_answers: ["ƒ∞stanbul", "ƒ∞zmir", "Bursa"],
                    difficulty: "easy"
                },
                {
                    question: "D√ºnya'nƒ±n en b√ºy√ºk gezegeni hangisidir?",
                    correct_answer: "J√ºpiter",
                    incorrect_answers: ["Sat√ºrn", "Nept√ºn", "D√ºnya"],
                    difficulty: "easy"
                },
                {
                    question: "144'√ºn karek√∂k√º ka√ßtƒ±r?",
                    correct_answer: "12",
                    incorrect_answers: ["14", "16", "10"],
                    difficulty: "easy"
                },
                {
                    question: "Hangi elementin kimyasal sembol√º 'Au'dur?",
                    correct_answer: "Altƒ±n",
                    incorrect_answers: ["G√ºm√º≈ü", "Al√ºminyum", "Argon"],
                    difficulty: "medium"
                },
                {
                    question: "ƒ∞nsan v√ºcudunda ka√ß kemik vardƒ±r?",
                    correct_answer: "206",
                    incorrect_answers: ["205", "208", "210"],
                    difficulty: "medium"
                },
                {
                    question: "Hangi vitamin g√ºne≈ü ƒ±≈üƒ±ƒüƒ±ndan elde edilir?",
                    correct_answer: "D Vitamini",
                    incorrect_answers: ["C Vitamini", "A Vitamini", "B12 Vitamini"],
                    difficulty: "hard"
                }
            ],
            gaming: [
                {
                    question: "Minecraft oyununu hangi ≈üirket yaratmƒ±≈ütƒ±r?",
                    correct_answer: "Mojang",
                    incorrect_answers: ["Microsoft", "Sony", "Nintendo"],
                    difficulty: "easy"
                },
                {
                    question: "ƒ∞lk Pokemon oyunu hangi yƒ±l √ßƒ±kmƒ±≈ütƒ±r?",
                    correct_answer: "1996",
                    incorrect_answers: ["1994", "1998", "1995"],
                    difficulty: "medium"
                },
                {
                    question: "Counter-Strike oyununda bomb defuse s√ºresi ka√ß saniyedir?",
                    correct_answer: "10 saniye",
                    incorrect_answers: ["5 saniye", "15 saniye", "7 saniye"],
                    difficulty: "medium"
                },
                {
                    question: "League of Legends'ta ka√ß ≈üampiyon vardƒ±r? (2024 itibariyle)",
                    correct_answer: "160+",
                    incorrect_answers: ["150+", "140+", "170+"],
                    difficulty: "hard"
                },
                {
                    question: "Hangi oyun t√ºr√º 'FPS' olarak kƒ±saltƒ±lƒ±r?",
                    correct_answer: "First Person Shooter",
                    incorrect_answers: ["Fast Paced Strategy", "Fighting Player System", "Fantasy Role Playing"],
                    difficulty: "easy"
                }
            ],
            science: [
                {
                    question: "Bitkiler atmosferden hangi gazƒ± emerler?",
                    correct_answer: "Karbondioksit",
                    incorrect_answers: ["Oksijen", "Azot", "Hidrojen"],
                    difficulty: "easy"
                },
                {
                    question: "I≈üƒ±ƒüƒ±n bo≈üluktaki hƒ±zƒ± nedir?",
                    correct_answer: "299,792,458 m/s",
                    incorrect_answers: ["300,000,000 m/s", "299,000,000 m/s", "298,792,458 m/s"],
                    difficulty: "hard"
                },
                {
                    question: "Periyodik tabloda ka√ß element vardƒ±r?",
                    correct_answer: "118",
                    incorrect_answers: ["116", "120", "115"],
                    difficulty: "medium"
                },
                {
                    question: "DNA'nƒ±n a√ßƒ±lƒ±mƒ± nedir?",
                    correct_answer: "Deoksiribon√ºkleik Asit",
                    incorrect_answers: ["Deoxi Riboz Asit", "Deoksi Ribon√ºkleik Amino", "Deoksi Riboz N√ºkleik Asit"],
                    difficulty: "hard"
                },
                {
                    question: "Su ka√ß derecede kaynar?",
                    correct_answer: "100¬∞C",
                    incorrect_answers: ["90¬∞C", "110¬∞C", "95¬∞C"],
                    difficulty: "easy"
                }
            ],
            history: [
                {
                    question: "ƒ∞kinci D√ºnya Sava≈üƒ± hangi yƒ±l sona ermi≈ütir?",
                    correct_answer: "1945",
                    incorrect_answers: ["1944", "1946", "1943"],
                    difficulty: "easy"
                },
                {
                    question: "Aya ayak basan ilk insan kimdir?",
                    correct_answer: "Neil Armstrong",
                    incorrect_answers: ["Buzz Aldrin", "John Glenn", "Alan Shepard"],
                    difficulty: "medium"
                },
                {
                    question: "Osmanlƒ± ƒ∞mparatorluƒüu hangi yƒ±l kurulmu≈ütur?",
                    correct_answer: "1299",
                    incorrect_answers: ["1300", "1298", "1301"],
                    difficulty: "medium"
                },
                {
                    question: "T√ºrkiye Cumhuriyeti hangi yƒ±l kurulmu≈ütur?",
                    correct_answer: "1923",
                    incorrect_answers: ["1922", "1924", "1920"],
                    difficulty: "easy"
                },
                {
                    question: "ƒ∞stanbul'un fethi hangi yƒ±l ger√ßekle≈ümi≈ütir?",
                    correct_answer: "1453",
                    incorrect_answers: ["1452", "1454", "1451"],
                    difficulty: "medium"
                },
                {
                    question: "Atat√ºrk hangi ≈üehirde doƒümu≈ütur?",
                    correct_answer: "Selanik",
                    incorrect_answers: ["ƒ∞stanbul", "Ankara", "ƒ∞zmir"],
                    difficulty: "hard"
                }
            ]
        };
    },
    
    shuffleArray(array) {
        const shuffled = [...array];
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
    },
    
    // Trivia data management
    triviaData: new Map(),
    
    storeTriviaData(userId, data) {
        this.triviaData.set(userId, data);
    },
    
    getTriviaData(userId) {
        return this.triviaData.get(userId);
    },
    
    clearTriviaData(userId) {
        this.triviaData.delete(userId);
    },
    
    async handleTriviaAnswer(interaction, isCorrect) {
        console.log(`üéØ Trivia answer handler called for user ${interaction.user.id}, isCorrect: ${isCorrect}`);
        const triviaData = this.getTriviaData(interaction.user.id);
        console.log(`üéØ Trivia data found:`, triviaData ? 'Yes' : 'No');
        if (!triviaData) {
            return interaction.reply({ content: '‚ùå Oyun bulunamadƒ±! L√ºtfen yeni bir soru ba≈ülatƒ±n.', ephemeral: true });
        }
        
        // Check if already answered
        if (triviaData.answered) {
            return interaction.reply({ content: '‚ùå Bu soruyu zaten cevapladƒ±nƒ±z!', ephemeral: true });
        }
        
        triviaData.answered = true;
        
        let rewardText = '';
        let newXP = triviaData.userStats.total_xp;
        let newCoins = triviaData.userStats.coins;
        
        if (isCorrect) {
            // Give full rewards for correct answer
            newXP += triviaData.xpReward;
            newCoins += triviaData.coinReward;
            rewardText = `üéâ Doƒüru cevap! +${triviaData.xpReward} XP, +${triviaData.coinReward} coin kazandƒ±nƒ±z!`;
        } else {
            // Give participation reward for wrong answer
            newXP += 5;
            rewardText = `‚ùå Yanlƒ±≈ü cevap! Doƒüru cevap: **${triviaData.question.correct_answer}**\n+5 XP (katƒ±lƒ±m √∂d√ºl√º)`;
        }
        
        // Update user stats
        await triviaData.voiceManager.updateUserStats(
            interaction.user.id,
            interaction.guildId,
            newXP,
            newCoins,
            triviaData.userStats.voice_time_minutes
        );
        
        // Check for level up
        const oldLevel = Math.floor(triviaData.userStats.total_xp / 100);
        const newLevel = Math.floor(newXP / 100);
        
        if (newLevel > oldLevel) {
            const member = interaction.guild.members.cache.get(interaction.user.id);
            if (member) {
                console.log(`üéâ User ${interaction.user.username} leveled up from ${oldLevel} to ${newLevel} through trivia`);
                await triviaData.voiceManager.handleLevelUp(member, newLevel);
            }
        }
        
        // Create result embed
        const resultEmbed = new EmbedBuilder()
            .setColor(isCorrect ? '#00FF00' : '#FF6B00')
            .setTitle(isCorrect ? 'üéâ Doƒüru Cevap!' : '‚ùå Yanlƒ±≈ü Cevap!')
            .setDescription(rewardText)
            .addFields(
                { name: 'üí∞ Yeni Bakiye', value: `${newCoins} coin`, inline: true },
                { name: 'üìà Toplam XP', value: `${newXP} XP`, inline: true },
                { name: '‚≠ê Seviye', value: `Seviye ${newLevel}`, inline: true }
            )
            .setFooter({ text: 'Ba≈üka bir soru deneyiniz!' })
            .setTimestamp();
        
        await interaction.update({ embeds: [resultEmbed], components: [] });
        
        // Clean up
        this.triviaData.delete(interaction.user.id);
    },
    
    triviaData: new Map(),
    
    storeTriviaData(userId, data) {
        console.log(`üéØ Storing trivia data for user ${userId}`);
        this.triviaData.set(userId, data);
        console.log(`üéØ Trivia data stored. Total entries: ${this.triviaData.size}`);
        // Clean up after 10 minutes to prevent memory leaks
        setTimeout(() => {
            if (this.triviaData.has(userId)) {
                console.log(`üéØ Cleaning up expired trivia data for user ${userId}`);
                this.triviaData.delete(userId);
            }
        }, 10 * 60 * 1000);
    },
    
    getCategoryDisplayName(category) {
        const names = {
            'general': 'Genel Bilgi',
            'gaming': 'Oyun',
            'science': 'Bilim',
            'history': 'Tarih',
            'random': 'Rastgele'
        };
        return names[category] || category;
    },
    
    getDifficultyDisplayName(difficulty) {
        const names = {
            'easy': 'Kolay',
            'medium': 'Orta',
            'hard': 'Zor'
        };
        return names[difficulty] || difficulty;
    }
};